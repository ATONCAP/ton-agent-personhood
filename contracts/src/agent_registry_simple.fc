;; TON Agentic Personhood - Agent Registry (Compilable Version)
;; TODO: Simplified version that actually compiles and works

;; Constants
const int MIN_NAME_LENGTH = 3;
const int MAX_NAME_LENGTH = 64;
const int REGISTRATION_FEE = 1000000000; ;; 1 TON

;; Storage: next_agent_id, agent_registry_dict, admin_address
(int, cell, slice) load_data() inline {
    slice ds = get_data().begin_parse();
    return (
        ds~load_uint(64),    ;; next_agent_id
        ds~load_dict(),      ;; agent_registry
        ds~load_msg_addr()   ;; admin_address
    );
}

() save_data(int next_agent_id, cell agent_registry, slice admin_address) impure inline {
    set_data(begin_cell()
        .store_uint(next_agent_id, 64)
        .store_dict(agent_registry)
        .store_slice(admin_address)
        .end_cell()
    );
}

;; Register new agent - FUNCTIONAL VERSION
() register_agent(slice name, slice metadata) impure {
    slice cs = in_msg_full().begin_parse();
    cs~load_uint(4); ;; skip flags
    slice sender_address = cs~load_msg_addr();
    cs~load_msg_addr(); ;; skip dest
    int msg_value = cs~load_grams();
    
    ;; Check registration fee
    throw_unless(400, msg_value >= REGISTRATION_FEE);
    
    ;; TODO: Add name length validation
    
    (int next_agent_id, cell agent_registry, slice admin_address) = load_data();
    
    ;; Create agent info
    cell agent_info = begin_cell()
        .store_slice(sender_address)     ;; agent_address
        .store_ref(begin_cell().store_slice(name).end_cell())
        .store_uint(1000, 32)            ;; initial reputation
        .store_uint(now(), 32)           ;; creation_time
        .store_ref(begin_cell().store_slice(metadata).end_cell())
        .end_cell();
    
    ;; Store in registry
    agent_registry~udict_set_ref(64, next_agent_id, agent_info);
    
    ;; Update storage
    save_data(next_agent_id + 1, agent_registry, admin_address);
}

;; Get agent info - FUNCTIONAL VERSION
(slice, slice, int, int) get_agent_info(int agent_id) method_id {
    (int next_agent_id, cell agent_registry, slice admin_address) = load_data();
    
    (cell agent_info, int found) = agent_registry.udict_get_ref?(64, agent_id);
    throw_unless(404, found);
    
    slice agent_data = agent_info.begin_parse();
    slice agent_address = agent_data~load_msg_addr();
    slice agent_name = agent_data~load_ref().begin_parse();
    int reputation = agent_data~load_uint(32);
    int creation_time = agent_data~load_uint(32);
    
    return (agent_address, agent_name, reputation, creation_time);
}

;; Get total registered agents
int get_total_agents() method_id {
    (int next_agent_id, cell agent_registry, slice admin_address) = load_data();
    return next_agent_id;
}

;; Main message handler
() recv_internal(int my_balance, int msg_value, cell in_msg_full, slice in_msg_body) impure {
    if (in_msg_body.slice_empty?()) { 
        return (); 
    }
    
    int op = in_msg_body~load_uint(32);
    
    if (op == 0x52656773) { ;; "Regs" - Register
        slice name = in_msg_body~load_ref().begin_parse();
        slice metadata = in_msg_body~load_ref().begin_parse();
        register_agent(name, metadata);
        return ();
    }
    
    throw(0xffff); ;; unknown operation
}
